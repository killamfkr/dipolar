<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>dipolar – IPTV Player for CasaOS</title>
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --card:#111827;      /* gray-900 */
      --muted:#94a3b8;     /* slate-400 */
      --text:#e5e7eb;      /* gray-200 */
      --accent:#38bdf8;    /* sky-400 */
      --accent2:#22d3ee;   /* cyan-400 */
      --danger:#ef4444;    /* red-500 */
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(135deg,var(--bg),#020617);
      color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      display:flex; align-items:center; gap:12px; padding:20px 20px 8px;
    }
    .logo{ width:32px; height:32px; border-radius:8px; background:linear-gradient(135deg,var(--accent),var(--accent2)); }
    h1{ font-size:20px; margin:0 }
    main{ display:grid; grid-template-columns: 320px 1fr; gap:16px; padding:16px; flex:1; }
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.08);
      border-radius:16px; padding:14px; backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .controls{ display:flex; flex-direction:column; gap:10px; }
    label{ font-size:12px; color:var(--muted) }
    input[type="text"]{
      width:100%; padding:10px 12px; background:#0b1020; color:var(--text);
      border:1px solid rgba(255,255,255,0.08); border-radius:10px;
    }
    input[type="file"]{ width:100% }
    button{
      cursor:pointer; border:0; border-radius:12px; padding:10px 12px; color:#001018;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      font-weight:600;
    }
    button.secondary{ background:#0b1020; color:var(--text); border:1px solid rgba(255,255,255,0.08) }
    .grid{
      display:grid; grid-template-columns: repeat(2, 1fr); gap:8px;
    }
    .list{ max-height:calc(100vh - 260px); overflow:auto; padding-right:6px; }
    .channel{
      display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px;
      border:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02);
      cursor:pointer;
    }
    .channel:hover{ border-color: rgba(255,255,255,0.18) }
    .logoimg{ width:32px; height:32px; border-radius:6px; object-fit:cover; background:#0b1020; }
    .meta{ display:flex; flex-direction:column; line-height:1.2 }
    .name{ font-size:14px; font-weight:600 }
    .group{ font-size:11px; color:var(--muted) }
    .player{
      display:flex; flex-direction:column; gap:10px; height:100%;
    }
    video{
      width:100%; aspect-ratio:16/9; background:#000; border-radius:16px;
      outline: none; border:1px solid rgba(255,255,255,0.08);
    }
    .row{ display:flex; gap:8px; align-items:center; }
    .status{ font-size:12px; color:var(--muted) }
    .pill{ padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.08); font-size:11px }
    footer{ padding:10px 16px; text-align:center; color:var(--muted); font-size:12px }
    .search{ width:100%; padding:8px 10px; background:#0b1020; color:var(--text);
      border:1px solid rgba(255,255,255,0.08); border-radius:10px; }
    .hidden{ display:none }
  </style>
</head>
<body>
  <header>
    <div class="logo"></div>
    <h1>dipolar</h1>
    <div class="pill" id="buildTag">v1 • HTML+JS</div>
  </header>

  <main>
    <section class="panel">
      <div class="controls">
        <div>
          <label>M3U playlist URL (HLS/HTTP)</label>
          <input id="m3uUrl" type="text" placeholder="https://example.com/playlist.m3u or stream.m3u8" />
        </div>
        <div class="grid">
          <button id="loadUrl">Load URL</button>
          <button class="secondary" id="clearList">Clear</button>
        </div>
        <div>
          <label>…or upload a .m3u/.m3u8 file</label>
          <input id="m3uFile" type="file" accept=".m3u,.m3u8,text/plain" />
        </div>
        <div>
          <input id="search" class="search" type="text" placeholder="Search channels…" />
        </div>
      </div>
      <div class="list" id="channelList"></div>
    </section>

    <section class="panel player">
      <video id="video" controls playsinline></video>
      <div class="row">
        <button id="playPause">Play/Pause</button>
        <button class="secondary" id="mute">Mute</button>
        <button class="secondary" id="pip">PiP</button>
        <span class="status" id="nowPlaying">Idle</span>
      </div>
    </section>
  </main>

  <footer>Self‑hosted IPTV/M3U player • Deployable on CasaOS via Docker • Project: “dipolar”</footer>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const video = document.getElementById('video');
    const channelList = document.getElementById('channelList');
    const nowPlaying = document.getElementById('nowPlaying');
    const loadUrlBtn = document.getElementById('loadUrl');
    const m3uUrlInput = document.getElementById('m3uUrl');
    const m3uFileInput = document.getElementById('m3uFile');
    const clearBtn = document.getElementById('clearList');
    const searchInput = document.getElementById('search');

    let channels = []; // {name, group, logo, url}

    function setStatus(text){ nowPlaying.textContent = text; }

    function isHls(url){ return /\.m3u8(\?|$)/i.test(url); }

    function play(url, name){
      if(Hls.isSupported() && isHls(url)){
        const hls = new Hls({maxBufferLength: 60});
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        hls.on(Hls.Events.ERROR, (e, data) => {
          console.warn('HLS error', data);
          setStatus('HLS Error: ' + (data && data.details || 'unknown'));
        });
      }else{
        video.src = url;
        video.play().catch(()=>{});
      }
      setStatus('Playing: ' + (name || url));
    }

    function render(list){
      channelList.innerHTML = '';
      list.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'channel';
        div.innerHTML = \`
          <img class="logoimg" src="\${ch.logo || ''}" onerror="this.style.visibility='hidden'"/>
          <div class="meta">
            <div class="name">\${ch.name || 'Unknown'}</div>
            <div class="group">\${ch.group || ''}</div>
          </div>
        \`;
        div.addEventListener('click', () => play(ch.url, ch.name));
        channelList.appendChild(div);
      });
    }

    function parseM3U(text){
      const lines = text.split(/\r?\n/);
      const out = [];
      let current = null;
      for(let i=0;i<lines.length;i++){
        const line = lines[i].trim();
        if(!line) continue;
        if(line.startsWith('#EXTINF')){
          // Example: #EXTINF:-1 tvg-id="id" tvg-name="BBC One" tvg-logo="logo" group-title="News",BBC One
          const info = line;
          const nameMatch = info.match(/,(.*)$/);
          const name = nameMatch ? nameMatch[1].trim() : 'Channel';
          const logoMatch = info.match(/tvg-logo="([^"]*)"/);
          const groupMatch = info.match(/group-title="([^"]*)"/);
          current = {name, logo: logoMatch ? logoMatch[1] : '', group: groupMatch ? groupMatch[1] : ''};
        }else if(!line.startsWith('#')){
          if(current){
            out.push({...current, url: line});
            current = null;
          }else{
            // Direct URL line without EXTINF
            out.push({name: line.split('/').pop(), group:'', logo:'', url: line});
          }
        }
      }
      return out;
    }

    async function fetchText(url){
      const res = await fetch(url);
      if(!res.ok) throw new Error('HTTP ' + res.status);
      return await res.text();
    }

    loadUrlBtn.addEventListener('click', async () => {
      const url = m3uUrlInput.value.trim();
      if(!url) return;
      try{
        setStatus('Loading playlist…');
        const text = await fetchText(url);
        const parsed = parseM3U(text);
        channels = mergeChannels(channels, parsed);
        render(channels);
        setStatus('Loaded ' + parsed.length + ' channels');
      }catch(e){
        console.error(e);
        setStatus('Failed to load: ' + e.message);
      }
    });

    m3uFileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const text = await file.text();
      const parsed = parseM3U(text);
      channels = mergeChannels(channels, parsed);
      render(channels);
      setStatus('Imported ' + parsed.length + ' channels');
    });

    clearBtn.addEventListener('click', () => {
      channels = [];
      render(channels);
      setStatus('Cleared');
    });

    // Search filter
    searchInput.addEventListener('input', () => {
      const q = searchInput.value.toLowerCase();
      const filtered = channels.filter(c =>
        c.name.toLowerCase().includes(q) ||
        (c.group && c.group.toLowerCase().includes(q))
      );
      render(filtered);
    });

    // Basic player controls
    document.getElementById('playPause').addEventListener('click', () => {
      if(video.paused) video.play(); else video.pause();
    });
    document.getElementById('mute').addEventListener('click', () => {
      video.muted = !video.muted;
    });
    document.getElementById('pip').addEventListener('click', async () => {
      if(document.pictureInPictureElement){
        await document.exitPictureInPicture();
      }else if(document.pictureInPictureEnabled){
        await video.requestPictureInPicture().catch(()=>{});
      }
    });

    function mergeChannels(oldList, newList){
      const map = new Map();
      [...oldList, ...newList].forEach(c => {
        const key = c.name + '|' + c.url;
        if(!map.has(key)) map.set(key, c);
      });
      return [...map.values()];
    }
  </script>
</body>
</html>
